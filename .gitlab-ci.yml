---
stages:
  - syntax
  - unit_test
  - g10k_deploy

variables:
  LITMUS_CENTOS7: "litmusimage/centos:7"
  LITMUS_CENTOS6: "litmusimage/centos:6"

run_validation:
  stage: syntax
  script:
    - pdk validate puppet,metadata,ruby --parallel
  tags:
    - shared-runner

run_unit_test:
  stage: unit_test
  script:
    - pdk bundle exec rake spec_prep
    - pdk bundle exec rake "litmus:provision[docker, ${LITMUS_CENTOS7}]"
    - pdk bundle exec rake 'litmus:install_agent[puppet7]'
    - pdk bundle exec rake litmus:install_module
    - pdk bundle exec rake litmus:acceptance:parallel
  # only:
  #   - production
  #   - master    
  tags:
    - shared-runner

job_deploy:
  stage: g10k_deploy
  when: on_success
  script:
    - /home/gitlab-runner/bin/ci2puppet.sh ${CI_PROJECT_NAME} ${CI_COMMIT_REF_NAME}
  tags:
    - shared-runner
