---
stages:
  - revision_check
  - syntax
  - litmus_test_galera
  - litmus_test_proxysql
  - g10k_deploy

variables:
  CENTOS7_IMAGE: "litmusimage/centos:7"

revision_check:
  stage: revision_check
  script:
    - . ./spec/git-rev-count.sh ${CI_PROJECT_NAME} ${CI_COMMIT_REF_NAME}
  only:
    - uat
    - production
  tags:
    - shared-runner

run_validation:
  stage: syntax
  script:
    - pdk validate metadata,puppet,ruby,yaml --parallel
  tags:
    - shared-runner

litmus_test_galera:
  stage: litmus_test_galera
  script:
    - pdk bundle exec rake spec_prep
    - pdk bundle exec rake "litmus:provision[docker, ${CENTOS7_IMAGE}]"
    - pdk bundle exec rake 'litmus:install_agent[puppet7]'
    - pdk bundle exec rake litmus:install_module
    - HOST_TYPE=galera pdk bundle exec rake litmus:acceptance:parallel
  after_script:
    - pdk bundle exec rake litmus:tear_down
  only:
    - test
    - master
  tags:
    - shared-runner

test_proxysql:
  stage: litmus_test_proxysql
  script:
    - pdk bundle exec rake spec_prep
    - pdk bundle exec rake "litmus:provision[docker, ${CENTOS7_IMAGE}]"
    - pdk bundle exec rake 'litmus:install_agent[puppet7]'
    - pdk bundle exec rake litmus:install_module
    - HOST_TYPE=proxysql pdk bundle exec rake litmus:acceptance:parallel
  after_script:
    - pdk bundle exec rake litmus:tear_down
  only:
    - test
    - master
  tags:
    - shared-runner

job_deploy:
  stage: g10k_deploy
  when: on_success
  script:
    - /home/gitlab-runner/bin/ci2puppet.sh ${CI_PROJECT_NAME} ${CI_COMMIT_REF_NAME}
  tags:
    - shared-runner
